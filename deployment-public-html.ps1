# ===============================================
# DEPLOYMENT DIRECTO A PUBLIC_HTML - CPANEL
# FIME COMPANY - M√©todo directo cPanel
# ===============================================

Write-Host "üöÄ DEPLOYMENT DIRECTO PUBLIC_HTML - CPANEL" -ForegroundColor Cyan -BackgroundColor DarkBlue
Write-Host "==========================================" -ForegroundColor Yellow

# CONFIGURACI√ìN PUBLIC_HTML
$CPANEL_CONFIG = @{
    "HOST" = "fimecompany.com"
    "USER" = "fimecomp"
    "PUBLIC_HTML" = "/public_html"
    "LOCAL_FILES" = "C:\Users\PC\.android\c panel"
    "SSH_KEY" = "$env:USERPROFILE\.ssh\fimecompany_key"
}

Write-Host "üìÅ CONFIGURACI√ìN PUBLIC_HTML:" -ForegroundColor Green
Write-Host "   üåê Host: $($CPANEL_CONFIG.HOST)" -ForegroundColor White
Write-Host "   üë§ Usuario: $($CPANEL_CONFIG.USER)" -ForegroundColor White
Write-Host "   üìÇ Destino: $($CPANEL_CONFIG.PUBLIC_HTML)" -ForegroundColor White
Write-Host "   üíª Archivos locales: $($CPANEL_CONFIG.LOCAL_FILES)" -ForegroundColor White

# Funci√≥n para trabajar directamente con public_html
function Deploy-ToPublicHTML {
    Write-Host ""
    Write-Host "üöÄ SUBIENDO ARCHIVOS A PUBLIC_HTML" -ForegroundColor Cyan -BackgroundColor DarkBlue
    Write-Host "===================================" -ForegroundColor Yellow
    
    $localPath = $CPANEL_CONFIG.LOCAL_FILES
    $remotePath = $CPANEL_CONFIG.PUBLIC_HTML
    $sshUser = $CPANEL_CONFIG.USER
    $sshHost = $CPANEL_CONFIG.HOST
    $sshKey = $CPANEL_CONFIG.SSH_KEY
    
    Write-Host "üì§ M√©todo: SSH/SCP directo a public_html" -ForegroundColor Green
    Write-Host "üìÇ Ruta remota: $sshUser@$sshHost`:$remotePath" -ForegroundColor Cyan
    
    # Verificar conexi√≥n SSH
    Write-Host ""
    Write-Host "üîç Verificando conexi√≥n SSH..." -ForegroundColor Yellow
    
    try {
        $testConnection = ssh -i "$sshKey" "$sshUser@$sshHost" "pwd" 2>&1
        
        if ($LASTEXITCODE -eq 0) {
            Write-Host "‚úÖ Conexi√≥n SSH exitosa" -ForegroundColor Green
            Write-Host "üìÅ Directorio home: $testConnection" -ForegroundColor Cyan
        } else {
            Write-Host "‚ùå Error de conexi√≥n SSH: $testConnection" -ForegroundColor Red
            Write-Host "üîß Usando m√©todo alternativo (sin SSH)..." -ForegroundColor Yellow
            Deploy-ViaFileManager
            return
        }
    } catch {
        Write-Host "‚ùå SSH no disponible. Usando File Manager..." -ForegroundColor Yellow
        Deploy-ViaFileManager
        return
    }
    
    # Subir archivo principal index.html
    Write-Host ""
    Write-Host "üìÑ Subiendo index.html principal..." -ForegroundColor Green
    if (Test-Path "$localPath\index.html") {
        scp -i "$sshKey" "$localPath\index.html" "$sshUser@$sshHost`:$remotePath/"
        if ($LASTEXITCODE -eq 0) {
            Write-Host "‚úÖ index.html subido exitosamente" -ForegroundColor Green
        } else {
            Write-Host "‚ùå Error subiendo index.html" -ForegroundColor Red
        }
    } else {
        Write-Host "‚ö†Ô∏è index.html no encontrado en $localPath" -ForegroundColor Yellow
    }
    
    # Subir styles.css
    Write-Host "üìÑ Subiendo styles.css..." -ForegroundColor Green
    if (Test-Path "$localPath\styles.css") {
        scp -i "$sshKey" "$localPath\styles.css" "$sshUser@$sshHost`:$remotePath/"
        if ($LASTEXITCODE -eq 0) {
            Write-Host "‚úÖ styles.css subido exitosamente" -ForegroundColor Green
        } else {
            Write-Host "‚ùå Error subiendo styles.css" -ForegroundColor Red
        }
    }
    
    # Subir carpetas de divisiones
    $divisions = @("fimetech", "fimekids", "ferreteria", "constructora", "energia", "global", "imprexlaser", "inversiones")
    
    foreach ($division in $divisions) {
        Write-Host "üìÅ Subiendo carpeta $division..." -ForegroundColor Green
        
        if (Test-Path "$localPath\$division") {
            # Crear directorio remoto
            ssh -i "$sshKey" "$sshUser@$sshHost" "mkdir -p $remotePath/$division"
            
            # Subir carpeta completa
            scp -r -i "$sshKey" "$localPath\$division\*" "$sshUser@$sshHost`:$remotePath/$division/"
            
            if ($LASTEXITCODE -eq 0) {
                Write-Host "‚úÖ Carpeta $division subida exitosamente" -ForegroundColor Green
            } else {
                Write-Host "‚ùå Error subiendo carpeta $division" -ForegroundColor Red
            }
        } else {
            Write-Host "‚ö†Ô∏è Carpeta $division no encontrada" -ForegroundColor Yellow
        }
    }
    
    # Configurar permisos
    Write-Host ""
    Write-Host "üîß Configurando permisos en public_html..." -ForegroundColor Green
    
    $permissionCommands = @(
        "chmod 755 $remotePath",
        "chmod 644 $remotePath/*.html",
        "chmod 644 $remotePath/*.css",
        "chmod 644 $remotePath/*.js",
        "chmod -R 755 $remotePath/fimetech",
        "chmod -R 755 $remotePath/fimekids", 
        "chmod -R 755 $remotePath/ferreteria"
    )
    
    foreach ($cmd in $permissionCommands) {
        ssh -i "$sshKey" "$sshUser@$sshHost" "$cmd" 2>$null
        Write-Host "‚öôÔ∏è Ejecutado: $cmd" -ForegroundColor Cyan
    }
    
    Write-Host "‚úÖ Permisos configurados" -ForegroundColor Green
    
    # Verificar archivos subidos
    Write-Host ""
    Write-Host "üîç Verificando archivos en public_html..." -ForegroundColor Yellow
    
    $fileList = ssh -i "$sshKey" "$sshUser@$sshHost" "ls -la $remotePath"
    Write-Host "üìã Archivos en public_html:" -ForegroundColor Cyan
    Write-Host $fileList -ForegroundColor White
    
    Write-Host ""
    Write-Host "üéâ ¬°DEPLOYMENT A PUBLIC_HTML COMPLETADO!" -ForegroundColor Green -BackgroundColor DarkGreen
    Write-Host "=========================================" -ForegroundColor Yellow
    Write-Host "‚úÖ Archivos subidos a public_html" -ForegroundColor Green
    Write-Host "‚úÖ Permisos configurados correctamente" -ForegroundColor Green
    Write-Host "‚úÖ Sitio web disponible p√∫blicamente" -ForegroundColor Green
}

# M√©todo alternativo via File Manager (manual)
function Deploy-ViaFileManager {
    Write-Host ""
    Write-Host "üìÅ M√âTODO ALTERNATIVO - FILE MANAGER" -ForegroundColor Cyan -BackgroundColor DarkBlue
    Write-Host "====================================" -ForegroundColor Yellow
    
    Write-Host "üîß SSH no disponible. Usa File Manager de cPanel:" -ForegroundColor Yellow
    Write-Host ""
    Write-Host "üìã PASOS MANUALES:" -ForegroundColor Green
    Write-Host "1. Entra a cPanel ‚Üí File Manager" -ForegroundColor White
    Write-Host "2. Ve a la carpeta 'public_html'" -ForegroundColor White
    Write-Host "3. Sube estos archivos desde '$($CPANEL_CONFIG.LOCAL_FILES)':" -ForegroundColor White
    Write-Host ""
    Write-Host "üìÑ ARCHIVOS A SUBIR:" -ForegroundColor Cyan
    Write-Host "   ‚Ä¢ index.html (archivo principal)" -ForegroundColor White
    Write-Host "   ‚Ä¢ styles.css (estilos)" -ForegroundColor White
    Write-Host ""
    Write-Host "üìÅ CARPETAS A SUBIR:" -ForegroundColor Cyan
    Write-Host "   ‚Ä¢ fimetech/ (completa)" -ForegroundColor White
    Write-Host "   ‚Ä¢ fimekids/ (completa)" -ForegroundColor White  
    Write-Host "   ‚Ä¢ ferreteria/ (completa)" -ForegroundColor White
    Write-Host "   ‚Ä¢ constructora/ (completa)" -ForegroundColor White
    Write-Host "   ‚Ä¢ energia/ (completa)" -ForegroundColor White
    Write-Host "   ‚Ä¢ global/ (completa)" -ForegroundColor White
    Write-Host "   ‚Ä¢ imprexlaser/ (completa)" -ForegroundColor White
    Write-Host "   ‚Ä¢ inversiones/ (completa)" -ForegroundColor White
    Write-Host ""
    Write-Host "üîß DESPU√âS DE SUBIR:" -ForegroundColor Yellow
    Write-Host "   ‚Ä¢ Selecciona todos los archivos" -ForegroundColor White
    Write-Host "   ‚Ä¢ Click derecho ‚Üí Permissions" -ForegroundColor White
    Write-Host "   ‚Ä¢ Carpetas: 755, Archivos: 644" -ForegroundColor White
    Write-Host ""
    Write-Host "üåê VERIFICAR:" -ForegroundColor Green
    Write-Host "   ‚Ä¢ https://fimecompany.com" -ForegroundColor Cyan
    Write-Host "   ‚Ä¢ https://fimecompany.com/fimetech/" -ForegroundColor Cyan
    Write-Host "   ‚Ä¢ https://fimecompany.com/fimekids/" -ForegroundColor Cyan
}

# Funci√≥n para verificar sitio p√∫blico
function Test-PublicWebsite {
    Write-Host ""
    Write-Host "üåê VERIFICANDO SITIO P√öBLICO" -ForegroundColor Cyan -BackgroundColor DarkBlue
    Write-Host "============================" -ForegroundColor Yellow
    
    $urls = @(
        "https://fimecompany.com",
        "https://fimecompany.com/fimetech/",
        "https://fimecompany.com/fimekids/",
        "https://fimecompany.com/ferreteria/"
    )
    
    foreach ($url in $urls) {
        Write-Host "üîç Probando: $url" -ForegroundColor Yellow
        
        try {
            $response = Invoke-WebRequest -Uri $url -Method Head -TimeoutSec 10 -ErrorAction Stop
            
            if ($response.StatusCode -eq 200) {
                Write-Host "‚úÖ $url - FUNCIONANDO (200)" -ForegroundColor Green
            } else {
                Write-Host "‚ö†Ô∏è $url - C√≥digo: $($response.StatusCode)" -ForegroundColor Yellow
            }
        } catch {
            Write-Host "‚ùå $url - NO DISPONIBLE" -ForegroundColor Red
            Write-Host "   Error: $($_.Exception.Message)" -ForegroundColor Red
        }
        
        Start-Sleep -Milliseconds 500
    }
    
    Write-Host ""
    Write-Host "üìã SITIO P√öBLICO VERIFICADO" -ForegroundColor Green
}

# Funci√≥n para crear backup antes del deployment
function Create-BackupBeforeDeploy {
    Write-Host "üíæ Creando backup antes del deployment..." -ForegroundColor Green
    
    $backupDate = Get-Date -Format "yyyyMMdd_HHmmss"
    $backupDir = "backup_$backupDate"
    
    ssh -i "$($CPANEL_CONFIG.SSH_KEY)" "$($CPANEL_CONFIG.USER)@$($CPANEL_CONFIG.HOST)" "mkdir -p ~/backups/$backupDir && cp -r $($CPANEL_CONFIG.PUBLIC_HTML)/* ~/backups/$backupDir/ 2>/dev/null || echo 'Primer deployment - sin backup necesario'"
    
    Write-Host "‚úÖ Backup creado (si hab√≠a archivos previos)" -ForegroundColor Green
}

Write-Host ""
Write-Host "üìã COMANDOS DISPONIBLES:" -ForegroundColor Yellow
Write-Host "========================" -ForegroundColor Yellow
Write-Host "üöÄ Deploy-ToPublicHTML        # Deployment directo SSH" -ForegroundColor White
Write-Host "üìÅ Deploy-ViaFileManager      # M√©todo manual File Manager" -ForegroundColor White
Write-Host "üåê Test-PublicWebsite         # Verificar sitio p√∫blico" -ForegroundColor White
Write-Host "üíæ Create-BackupBeforeDeploy  # Crear backup previo" -ForegroundColor White

Write-Host ""
Write-Host "üéØ DEPLOYMENT DIRECTO A PUBLIC_HTML:" -ForegroundColor Green
Write-Host "Deploy-ToPublicHTML" -ForegroundColor Yellow

Write-Host ""
Write-Host "üîß SI SSH NO FUNCIONA:" -ForegroundColor Yellow
Write-Host "Deploy-ViaFileManager" -ForegroundColor Cyan
